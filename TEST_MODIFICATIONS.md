# テスト関連の変更履歴

このファイルは、テストを通すために行った一時的な変更や、コメントアウトした箇所を記録するためのものです。

## 現在の変更点

### 1. ダッシュボード認証フローの簡略化

- **ファイル**: `app/routes/dashboard.tsx`
- **変更日**: 2025-01-23
- **変更内容**:
  - `setSession`呼び出しを削除し、サーバーから渡されたユーザー情報を直接使用するように変更
  - 複雑な認証チェックロジックを簡略化
- **理由**: セッション設定でハングする問題を回避するため
- **TODO**: Supabaseのセッション管理を正しく実装し直す

### 2. Supabaseクライアントの設定変更

- **ファイル**: `app/lib/supabase.client.ts`
- **変更日**: 2025-01-23
- **変更内容**:
  - `flowType: "implicit"`を削除（一時的に`flowType: "pkce"`を試したが元に戻した）
  - `storage: window.localStorage`を削除
- **理由**: 認証フローの互換性問題を回避するため

### 3. ヘッダー・ボトムナビの表示条件

- **ファイル**: `app/root.tsx`
- **変更日**: 2025-01-23
- **問題**: 保護されたルート（/dashboard等）でヘッダーとボトムナビが表示されない
- **原因**: `isLoggedIn`の初期化が非同期で、初期値が`null`または`false`
- **試した対策**:
  - 保護されたルートの場合は`isLoggedIn`の初期値を`true`に設定 → SSRの問題で機能せず
  - onAuthStateChangeでSIGNED_INイベントを即座に反映 → イベントが発生していない
- **残課題**: 認証状態の同期をより確実にする必要がある
- **一時的な対応案**: 各ページで個別にヘッダー・ボトムナビを表示する

## 過去の変更点

### LiveReloadのコメントアウト

- **ファイル**: `app/root.tsx`
- **変更日**: 不明
- **変更内容**: `<LiveReload />`をコメントアウト
- **理由**: 開発時のパフォーマンス問題？

## 推奨される改善点

1. **認証フローの統一**

   - サーバーサイドとクライアントサイドの認証状態を確実に同期させる
   - Remixのローダーから認証状態を渡す仕組みを構築

2. **テスト環境の改善**

   - E2Eテストでの認証状態のモック化
   - テスト専用の認証フローの実装

3. **設定の環境別管理**
   - 開発環境とテスト環境で異なる設定を使用できるようにする

## チェックリスト

本番デプロイ前に確認すること：

- [ ] すべての一時的な変更を本格的な実装に置き換える
- [ ] コメントアウトした機能の必要性を再評価
- [ ] 認証フローが本番環境で正しく動作することを確認
- [ ] ヘッダー・ボトムナビが全ての必要なページで表示されることを確認
